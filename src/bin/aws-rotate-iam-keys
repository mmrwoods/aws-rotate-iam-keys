#!/usr/bin/env bash

# Log to syslog if output streams not attached to a terminal (cron, launchd)
if ! test -t 1 && ! test -t 2; then
  exec 1> >(tee >(logger -t $(basename $0))) 2>&1
fi

# Assign the arguments to variables
# saner programming env: these switches turn some bugs into errors
set -eu -o errexit -o pipefail -o noclobber -o nounset
IFS=$'\n\t'

! getopt --test > /dev/null
if [[ ${PIPESTATUS[0]} -ne 4 ]]; then
    if which brew &> /dev/null && test -d $(brew --prefix)/opt/gnu-getopt/bin; then
        PATH="$(brew --prefix)/opt/gnu-getopt/bin:$PATH"
    else
        echo "GNU's enhanced getopt is required to run this script" >&2
        echo "You can usually find this in the util-linux package" >&2
        echo "On MacOS see homebrew's package: http://brewformulas.org/Gnu-getopt" >&2
        echo "For anyone else, build from source: http://frodo.looijaard.name/project/getopt" >&2
        exit 1
    fi
fi

# -use ! and PIPESTATUS to get exit code with errexit set
# -temporarily store output to be able to check for errors
# -activate quoting/enhanced mode (e.g. by writing out “--options”)
# -pass arguments only via   -- "$@"   to separate them correctly
! PARSED=$(getopt --options=hvp: --longoptions=profile:,profiles:,version,help --name "$0" -- "$@")
if [[ ${PIPESTATUS[0]} -ne 0 ]]; then
    # e.g. return value is 1
    #  then getopt has complained about wrong arguments to stdout
    exit 2
fi
# read getopt’s output this way to handle the quoting right:
eval set -- "$PARSED"

PROFILES=""
# now enjoy the options in order and nicely split until we see --
while true; do
    case "$1" in
        --)
          shift
          break
          ;;
        -p|--profiles|--profile)
          PROFILES="$2"
          shift 2
        ;;
        --version|-v)
          echo "AWS Rotate IAM Keys (c) 2018+ Adam Link."
          echo "Licensed under the GNU General Public License."
          echo "Thanks to all the contributors!"
          echo "version <<VERSION>>"
          exit 0
        ;;
        --help|-h)
          echo "To rotate your default profile manually:"
          echo '$ aws-rotate-iam-keys'
          echo ""
          echo "To rotate a specific profile in your ~/.aws/credentials file:"
          echo '$ aws-rotate-iam-keys --profile myProfile'
          echo ""
          echo "To rotate multiple profiles *with the same key*:"
          echo '$ aws-rotate-iam-keys --profiles myProfile,myOtherProfile'
          echo ""
          echo "To rotate multiple profiles *with their own keys*:"
          echo '$ aws-rotate-iam-keys --profile myProfile'
          echo '$ aws-rotate-iam-keys --profile myOtherProfile'
          exit 0
        ;;
    esac
done

# Set the profile to default if nothing sent via CLI
if [[ -z "$PROFILES" ]]; then
	PROFILES=default
fi

set -f; unset IFS             # avoid globbing (expansion of *).
PROFILES_ARR=(${PROFILES//,/ })
FIRST_PROFILE=${PROFILES_ARR[0]}

echo "Rotating iam keys for $PROFILES..."

echo "Verifying configuration"
for i in "${!PROFILES_ARR[@]}"
do
  ACCESS_KEY_ID=$(aws configure get ${PROFILES_ARR[i]}.aws_access_key_id 2>/dev/null)
  if [[ -z "$ACCESS_KEY_ID" ]]; then
    echo "Could not find key for profile ${PROFILES_ARR[i]}. Ensure you have a profile set up using 'aws configure'." >&2
    exit 1
  fi
  FIRST_KEY_ID=${FIRST_KEY_ID:-$ACCESS_KEY_ID}
done

echo "Verifying credentials"
KEY_COUNT=$(aws iam list-access-keys --output json --profile $FIRST_PROFILE | jq '.AccessKeyMetadata | length' || exit 1)
if [[ "$KEY_COUNT" -gt "1" ]]; then
  echo "You have more than 1 active access key. Ensure you only have 1 active access key and try again."
  exit 1
fi

echo "Creating new access key"
RESPONSE=$(aws iam create-access-key --output json --profile $FIRST_PROFILE | jq .AccessKey)
ACCESS_KEY=$(echo $RESPONSE | jq -r '.AccessKeyId')
SECRET=$(echo $RESPONSE | jq -r '.SecretAccessKey')
if [[ "$ACCESS_KEY" != "" && "$SECRET" != "" ]]; then
  echo "Created new key $ACCESS_KEY"

  echo "Deleting old access key"
  aws iam delete-access-key --access-key-id $FIRST_KEY_ID --profile $FIRST_PROFILE

  # Rotate the keys in the credentials file for all profiles
  for i in "${!PROFILES_ARR[@]}"
  do
      echo "Updating profile: ${PROFILES_ARR[i]}"
      aws configure set aws_access_key_id $ACCESS_KEY --profile ${PROFILES_ARR[i]}
      aws configure set aws_secret_access_key $SECRET --profile ${PROFILES_ARR[i]}
  done

  echo "Keys rotated"
  exit 0
else
  echo "Failed to create access key. Please correct reported errors and try again." >&2
  exit 1
fi
